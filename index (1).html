<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Personales - Datos Claros</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .btn-press:active { transform: scale(0.95); }
        #file-upload { display: none; }
        .editing-mode { border: 2px solid #f97316; background-color: #fff7ed; }
        .date-trigger-input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FUNCIONES AUXILIARES ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const INITIAL_DB_STRUCTURE = {
            meta: { version: "1.0", created_at: new Date().toISOString() },
            users: {
                administrador: {
                    transactions: [],
                    customCategories: ["Comida", "Transporte", "Casa", "Entretenimiento", "Salud", "Servicios"]
                }
            }
        };

        const App = () => {
            // --- ESTADOS ---
            const [db, setDb] = useState(INITIAL_DB_STRUCTURE);
            const [viewMode, setViewMode] = useState('monthly'); // 'daily' | 'weekly' | 'monthly'
            const [listTab, setListTab] = useState('expenses');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);
            
            const [formData, setFormData] = useState({
                type: 'expense',
                name: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                category: ''
            });

            // --- PERSISTENCIA ---
            useEffect(() => {
                const savedData = localStorage.getItem('basededatos_finanzas');
                if (savedData) {
                    try { setDb(JSON.parse(savedData)); } catch (e) { console.error(e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('basededatos_finanzas', JSON.stringify(db));
            }, [db]);

            // --- NAVEGACI√ìN DE TIEMPO ---
            const navigateTime = (direction) => {
                const newDate = new Date(selectedDate);
                if (viewMode === 'monthly') {
                    newDate.setMonth(newDate.getMonth() + direction);
                } else if (viewMode === 'weekly') {
                    newDate.setDate(newDate.getDate() + (direction * 7));
                } else { // daily
                    newDate.setDate(newDate.getDate() + direction);
                }
                setSelectedDate(newDate);
            };

            const handleDatePick = (e) => {
                const pickedDate = new Date(e.target.value + 'T00:00:00');
                setSelectedDate(pickedDate);
            };

            // --- ETIQUETA DEL HEADER ---
            const currentDateLabel = useMemo(() => {
                const year = selectedDate.getFullYear();
                const monthName = selectedDate.toLocaleString('es-MX', { month: 'long' });
                
                if (viewMode === 'monthly') {
                    return `${monthName} ${year}`.toUpperCase();
                } else if (viewMode === 'weekly') {
                    // Calcular rango Lunes - Domingo
                    const current = new Date(selectedDate);
                    const day = current.getDay(); 
                    const diff = current.getDate() - day + (day === 0 ? -6 : 1); // Ajuste al Lunes
                    
                    const monday = new Date(current);
                    monday.setDate(diff);
                    
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);

                    const formatOptions = { weekday: 'short', day: '2-digit', month: '2-digit' };
                    const startStr = monday.toLocaleDateString('es-MX', formatOptions).replace('.', '');
                    const endStr = sunday.toLocaleDateString('es-MX', formatOptions).replace('.', '');

                    return `${startStr} - ${endStr}`.toUpperCase();
                } else {
                    return selectedDate.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
                }
            }, [selectedDate, viewMode]);


            // --- FILTRADO ---
            const adminData = db.users.administrador;
            const transactions = adminData.transactions;
            const categories = adminData.customCategories;

            const filteredTransactions = useMemo(() => {
                const targetMonth = selectedDate.getMonth();
                const targetYear = selectedDate.getFullYear();
                const targetWeek = getWeekNumber(selectedDate);
                const targetDay = selectedDate.getDate();

                return transactions.filter(t => {
                    const tDate = new Date(t.date + 'T00:00:00'); 
                    
                    if (viewMode === 'monthly') {
                        return tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear;
                    } else if (viewMode === 'weekly') {
                        return getWeekNumber(tDate) === targetWeek && tDate.getFullYear() === targetYear;
                    } else { // daily
                        return tDate.getDate() === targetDay && tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear;
                    }
                });
            }, [transactions, viewMode, selectedDate]);

            // --- C√ÅLCULOS ---
            const summary = useMemo(() => {
                let income = 0;
                let expense = 0;
                filteredTransactions.forEach(t => {
                    if (t.type === 'income') income += parseFloat(t.amount);
                    if (t.type === 'expense') expense += parseFloat(t.amount);
                });
                return { income, expense, balance: income - expense };
            }, [filteredTransactions]);

            const listData = useMemo(() => {
                return filteredTransactions
                    .filter(t => (listTab === 'incomes' ? t.type === 'income' : t.type === 'expense'))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [filteredTransactions, listTab]);

            // --- MANEJO FORMULARIO ---
            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            const startEditing = (t) => {
                setEditingId(t.id);
                setFormData({ type: t.type, name: t.name, amount: t.amount, date: t.date, category: t.category });
                window.scrollTo({ top: 350, behavior: 'smooth' }); // Ajustado scroll por el nuevo header m√°s alto
            };

            const cancelEditing = () => {
                setEditingId(null);
                setFormData({ type: 'expense', name: '', amount: '', date: new Date().toISOString().split('T')[0], category: '' });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.amount || !formData.date || !formData.category) return;
                const amountVal = parseFloat(formData.amount);
                const updatedCategories = categories.includes(formData.category) ? categories : [...categories, formData.category];
                
                let updatedTransactions;
                if (editingId) {
                    updatedTransactions = transactions.map(t => t.id === editingId ? { ...t, ...formData, amount: amountVal } : t);
                    alert("‚úÖ Movimiento actualizado");
                } else {
                    updatedTransactions = [...transactions, { id: Date.now(), ...formData, amount: amountVal }];
                    alert("‚úÖ Movimiento registrado");
                }

                setDb({ ...db, users: { ...db.users, administrador: { transactions: updatedTransactions, customCategories: updatedCategories } } });
                cancelEditing();
            };

            const deleteTransaction = (id) => {
                if(!confirm("¬øBorrar permanentemente?")) return;
                const updatedTransactions = transactions.filter(t => t.id !== id);
                setDb({ ...db, users: { ...db.users, administrador: { ...adminData, transactions: updatedTransactions } } });
                if (editingId === id) cancelEditing();
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
                const link = document.createElement('a');
                link.href = dataStr;
                link.download = `Backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };

            const handleFileChange = (e) => {
                const reader = new FileReader();
                if (!e.target.files[0]) return;
                reader.readAsText(e.target.files[0], "UTF-8");
                reader.onload = (ev) => {
                    try {
                        const imp = JSON.parse(ev.target.result);
                        if (imp.users?.administrador) { setDb(imp); alert("‚úÖ Datos cargados correctamente."); }
                    } catch (err) { alert("‚ùå Error: El archivo no es v√°lido."); }
                };
                e.target.value = null; 
            };

            const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val);

            // --- RENDER ---
            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-100 flex flex-col shadow-2xl relative">
                    
                    {/* HEADER */}
                    <header className="bg-slate-900 text-white p-5 pb-16 rounded-b-[2.5rem] shadow-lg relative z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold">Finanzas Personales</h1>
                            <span className="text-xs bg-slate-700 px-2 py-1 rounded-full text-slate-300">Admin</span>
                        </div>

                        {/* SECCI√ìN DE DATOS CON TEXTO EXPLICATIVO */}
                        <div className="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-4 shadow-inner">
                            <div className="flex gap-2 mb-2">
                                <button 
                                    onClick={handleExport} 
                                    className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white text-xs py-2 px-2 rounded-lg font-bold flex items-center justify-center gap-1.5 transition-colors btn-press"
                                >
                                    <span>‚¨áÔ∏è</span> Descargar Backup
                                </button>
                                <button 
                                    onClick={() => fileInputRef.current.click()} 
                                    className="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 px-2 rounded-lg font-bold flex items-center justify-center gap-1.5 transition-colors btn-press"
                                >
                                    <span>üìÇ</span> Cargar Respaldo
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" id="file-upload" />
                            </div>
                            <p className="text-[10px] text-slate-400 text-center leading-tight">
                                ‚ÑπÔ∏è Usa estos botones para <b>guardar tu progreso</b> en un archivo o <b>restaurar</b> informaci√≥n anterior si cambias de navegador.
                            </p>
                        </div>

                        {/* CONTROLES DE FECHA */}
                        <div className="flex items-center justify-between bg-slate-800 rounded-xl p-2 mb-3 border border-slate-700 relative">
                            <button onClick={() => navigateTime(-1)} className="p-2 text-slate-300 hover:text-white rounded-lg z-30">‚óÄ</button>
                            
                            <div className="relative flex-1 text-center h-full flex flex-col justify-center overflow-hidden">
                                <input 
                                    type="date" 
                                    onChange={handleDatePick}
                                    className="date-trigger-input"
                                    title="Toca para cambiar la fecha desde el calendario"
                                />
                                <span className="block text-xs font-bold text-white tracking-wide px-1">
                                    {currentDateLabel}
                                </span>
                                <span className="text-[9px] text-blue-400 mt-0.5">üìÖ Toca para cambiar</span>
                            </div>

                            <button onClick={() => navigateTime(1)} className="p-2 text-slate-300 hover:text-white rounded-lg z-30">‚ñ∂</button>
                        </div>
                        
                        {/* VISTAS */}
                        <div className="flex bg-slate-800 rounded-lg p-1 gap-1">
                            <button onClick={() => setViewMode('daily')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${viewMode === 'daily' ? 'bg-white text-slate-900' : 'text-slate-400 hover:bg-slate-700'}`}>Diario</button>
                            <button onClick={() => setViewMode('weekly')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${viewMode === 'weekly' ? 'bg-white text-slate-900' : 'text-slate-400 hover:bg-slate-700'}`}>Semanal</button>
                            <button onClick={() => setViewMode('monthly')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${viewMode === 'monthly' ? 'bg-white text-slate-900' : 'text-slate-400 hover:bg-slate-700'}`}>Mensual</button>
                        </div>
                    </header>

                    {/* RESUMEN FLOTANTE */}
                    <div className="px-5 -mt-10 grid grid-cols-2 gap-4 z-20">
                        <div className="bg-white p-4 rounded-2xl shadow-md border-b-4 border-emerald-500">
                            <p className="text-[10px] text-slate-400 font-bold uppercase">Ingresos</p>
                            <p className="text-emerald-600 font-bold text-lg truncate">{formatCurrency(summary.income)}</p>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-md border-b-4 border-rose-500">
                            <p className="text-[10px] text-slate-400 font-bold uppercase">Gastos</p>
                            <p className="text-rose-600 font-bold text-lg truncate">{formatCurrency(summary.expense)}</p>
                        </div>
                    </div>
                    
                    <div className="px-5 mt-4">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                            <div className="text-left">
                                <p className="text-[10px] text-slate-400 font-bold uppercase">Balance</p>
                                <p className="text-xs text-slate-400">
                                    {viewMode === 'daily' ? 'Este D√≠a' : viewMode === 'weekly' ? 'Esta Semana' : 'Este Mes'}
                                </p>
                            </div>
                            <p className={`text-2xl font-black ${summary.balance >= 0 ? 'text-slate-800' : 'text-rose-600'}`}>
                                {formatCurrency(summary.balance)}
                            </p>
                        </div>
                    </div>

                    {/* FORMULARIO */}
                    <div className="p-5">
                        <div className={`p-4 rounded-2xl shadow-sm border space-y-3 transition-colors ${editingId ? 'editing-mode' : 'bg-white border-slate-100'}`}>
                            <div className="flex justify-between items-center mb-1">
                                <h3 className={`text-xs font-bold uppercase ${editingId ? 'text-orange-600' : 'text-slate-400'}`}>
                                    {editingId ? '‚úèÔ∏è Editando' : 'üìù Nuevo Movimiento'}
                                </h3>
                                {editingId && <button onClick={cancelEditing} className="text-xs bg-gray-200 px-2 py-1 rounded">Cancelar</button>}
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-3">
                                <div className="flex gap-2">
                                    <select name="type" value={formData.type} onChange={handleInputChange} className={`flex-1 p-2.5 rounded-xl border font-bold text-sm ${formData.type === 'income' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'}`}>
                                        <option value="income">Ingreso (+)</option>
                                        <option value="expense">Gasto (-)</option>
                                    </select>
                                    <input type="date" name="date" value={formData.date} onChange={handleInputChange} required className="flex-1 p-2.5 border border-slate-200 rounded-xl text-sm bg-white" />
                                </div>
                                <input type="text" name="name" placeholder="Concepto" value={formData.name} onChange={handleInputChange} required className="w-full p-3 border border-slate-200 rounded-xl text-sm bg-white" />
                                <div className="flex gap-2">
                                    <input type="number" name="amount" step="0.01" placeholder="0.00" value={formData.amount} onChange={handleInputChange} required className="w-1/3 p-3 border border-slate-200 rounded-xl text-sm font-mono bg-white" />
                                    <div className="relative w-2/3">
                                        <input type="text" name="category" list="category-list" placeholder="Categor√≠a" value={formData.category} onChange={handleInputChange} required className="w-full p-3 border border-slate-200 rounded-xl text-sm bg-white" />
                                        <datalist id="category-list">{categories.map((cat, idx) => <option key={idx} value={cat} />)}</datalist>
                                    </div>
                                </div>
                                <button type="submit" className={`w-full text-white py-3.5 rounded-xl font-bold text-sm shadow-lg btn-press ${editingId ? 'bg-orange-500' : 'bg-slate-900'}`}>
                                    {editingId ? 'Guardar Cambios' : 'Agregar Movimiento'}
                                </button>
                            </form>
                        </div>
                    </div>

                    {/* LISTA */}
                    <div className="flex-1 bg-white rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)] overflow-hidden flex flex-col border-t border-slate-100">
                        <div className="flex border-b border-slate-100">
                            <button onClick={() => setListTab('incomes')} className={`flex-1 py-4 text-xs uppercase font-bold tracking-wide ${listTab === 'incomes' ? 'text-emerald-600 bg-emerald-50/50 border-b-2 border-emerald-500' : 'text-slate-400'}`}>Ingresos</button>
                            <button onClick={() => setListTab('expenses')} className={`flex-1 py-4 text-xs uppercase font-bold tracking-wide ${listTab === 'expenses' ? 'text-rose-600 bg-rose-50/50 border-b-2 border-rose-500' : 'text-slate-400'}`}>Gastos</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-2 pb-8">
                            {listData.length === 0 ? (
                                <div className="text-center text-slate-300 mt-12">
                                    <p className="text-sm font-medium">Sin movimientos</p>
                                </div>
                            ) : (
                                listData.map((t) => (
                                    <div key={t.id} className={`flex justify-between items-center bg-white p-3 rounded-2xl border transition-all ${editingId === t.id ? 'border-orange-400 bg-orange-50' : 'border-slate-100 hover:shadow-md'}`}>
                                        <div className="flex items-center gap-3">
                                            <div className={`w-1.5 h-10 rounded-full ${t.type === 'income' ? 'bg-emerald-400' : 'bg-rose-400'}`}></div>
                                            <div>
                                                <p className="font-bold text-slate-800 text-sm">{t.name}</p>
                                                <div className="flex items-center gap-2 text-[10px] text-slate-500 mt-0.5">
                                                    <span className="bg-slate-100 px-2 py-0.5 rounded-md uppercase tracking-wider">{t.category}</span>
                                                    <span>{new Date(t.date).toLocaleDateString('es-MX', {day: '2-digit', month: 'short'})}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right flex flex-col items-end gap-1">
                                            <p className={`font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>{t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}</p>
                                            <div className="flex gap-2">
                                                <button onClick={() => startEditing(t)} className="text-[10px] text-blue-500 font-bold hover:underline">Editar</button>
                                                <button onClick={() => deleteTransaction(t.id)} className="text-[10px] text-rose-300 hover:text-rose-600 hover:underline">Borrar</button>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


