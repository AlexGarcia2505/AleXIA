<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AleXIA V21 - Mobile Fix</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS FIX MOBILE --- */
        :root {
            --bg-body: #131314;
            --bg-sidebar: #1e1f20;
            --bg-input: #282a2c;
            --text-main: #e3e3e3;
            --accent: #a8c7fa; 
            --user-msg: #282a2c; 
            --ai-msg: transparent;
            --danger: #ff897d;
        }

        /* Usamos dvh (dynamic viewport height) para arreglar el problema de m√≥viles */
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; height: 100dvh; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar {
            width: 280px; background: var(--bg-sidebar); height: 100%;
            display: flex; flex-direction: column; transition: transform 0.3s ease;
            position: absolute; z-index: 50; left: 0; top: 0; bottom: 0;
            transform: translateX(-100%); border-right: 1px solid #333;
        }
        .sidebar.open { transform: translateX(0); }
        
        /* MAIN CHAT */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; width: 100%; }
        
        .top-bar { 
            padding: 15px; display: flex; align-items: center; gap: 15px; 
            position: absolute; top: 0; left: 0; right: 0; z-index: 10; 
            background: rgba(19, 19, 20, 0.9); backdrop-filter: blur(5px);
        }
        .menu-btn { background: none; border: none; color: white; font-size: 1.4rem; cursor: pointer; padding: 5px; }

        /* CHAT BOX con padding extra abajo para que no lo tape el input */
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 70px 20px 100px 20px; 
            display: flex; flex-direction: column; gap: 20px; 
            max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; 
        }

        .msg-row { display: flex; gap: 15px; animation: fadeIn 0.3s; }
        .msg-row.user-row { justify-content: flex-end; }
        .msg-icon { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        .icon-ai { background: linear-gradient(135deg, #4285f4, #9b72cb); color: white; }
        .msg-bubble { max-width: 75%; line-height: 1.5; font-size: 1rem; }
        .user-row .msg-bubble { background: var(--user-msg); padding: 10px 18px; border-radius: 20px 20px 4px 20px; }
        
        /* INPUT FIXED (SOLUCI√ìN M√ìVIL) */
        .input-container {
            position: fixed; /* Fijo para que no se mueva */
            bottom: 0; left: 0; right: 0;
            padding: 15px; background: var(--bg-body);
            display: flex; justify-content: center;
            z-index: 20; border-top: 1px solid #333;
        }
        .input-wrapper {
            background: var(--bg-input); width: 100%; max-width: 800px;
            border-radius: 30px; display: flex; align-items: center;
            padding: 8px 15px; border: 1px solid #444;
        }
        .chat-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; font-size: 16px; } /* font-size 16px evita zoom en iOS */
        .send-btn { background: var(--text-main); color: #000; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        /* DETECTOR DE ERRORES VISUAL */
        #error-console {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); color: #ff5555; z-index: 9999;
            padding: 20px; overflow: auto; font-family: monospace;
        }

        /* MODALES */
        .modal { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .card { background: #1e1f20; padding: 30px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #444; }
        .btn-full { width: 100%; padding: 12px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; background: var(--accent); }
        
        .guest-badge { position: absolute; top: 15px; right: 15px; background: #333; color: #aaa; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; pointer-events: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }
    </style>
</head>
<body>

<!-- CONSOLA DE ERRORES EN PANTALLA -->
<div id="error-console">
    <h3>‚ö†Ô∏è Error Detectado</h3>
    <p>Si ves esto, algo sali√≥ mal en el c√≥digo.</p>
    <div id="error-msg" style="border:1px solid #555; padding:10px; background:#222;"></div>
    <button onclick="document.getElementById('error-console').style.display='none'" style="margin-top:20px; padding:10px;">Cerrar</button>
</div>

<script>
    // Atrapa errores globales y los muestra en el celular
    window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('error-console').style.display = 'block';
        document.getElementById('error-msg').innerHTML += `‚ùå ${message}<br><small>${source}:${lineno}</small><br><br>`;
    };
</script>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; font-size:1.1rem;">Men√∫</span>
        <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1.2rem;"><i class="fas fa-times"></i></button>
    </div>
    <div style="padding:0 15px;">
        <button onclick="openLogin()" style="width:100%; padding:10px; background:#282a2c; color:white; border:none; border-radius:10px; text-align:left;">
            <i class="fas fa-user-circle"></i> <span id="u-name-side">Invitado</span>
        </button>
        <div id="logout-opt" style="display:none; margin-top:10px;">
            <button onclick="userLogout()" style="color:var(--danger); background:none; border:none;">Cerrar Sesi√≥n</button>
        </div>
    </div>
</div>

<!-- MAIN -->
<div class="main-content">
    <div class="top-bar">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <span style="font-weight:500;">AleXIA</span>
        <div id="guest-counter" class="guest-badge" style="display:none;">5 restantes</div>
    </div>

    <div id="chat-box">
        <div style="text-align:center; margin-top:60px; opacity:0.6;">
            <i class="fas fa-sparkles" style="font-size:3rem; margin-bottom:20px; background:linear-gradient(45deg, #4285f4, #d96570); -webkit-background-clip:text; color:transparent;"></i>
            <h2>¬øQu√© tienes en mente?</h2>
        </div>
    </div>

    <div class="input-container">
        <div class="input-wrapper">
            <input type="text" id="chat-input" class="chat-input" placeholder="Escribe aqu√≠..." autocomplete="off">
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>
</div>

<!-- LOGIN MODAL -->
<div id="auth-modal" class="modal">
    <div class="card">
        <h2>Bienvenido</h2>
        <button class="btn-full" style="background:white; color:black; display:flex; align-items:center; justify-content:center; gap:10px;" onclick="googleLogin()">
            <i class="fab fa-google"></i> Continuar con Google
        </button>
        <button onclick="closeModal()" style="background:none; border:none; color:#777; margin-top:15px;">Cancelar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // --------------------------------------------------------
    // ‚ö†Ô∏è ATENCI√ìN: PEGA TUS LLAVES AQU√ç CON CUIDADO
    // Aseg√∫rate de que no falten comillas ni comas
    // --------------------------------------------------------
     
    // Import the functions you need from the SDKs you need

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAeNVoB1ZasZSauIf6G7GbIa4bbJJ3_5cw",
  authDomain: "alexia-1c4f2.firebaseapp.com",
  projectId: "alexia-1c4f2",
  storageBucket: "alexia-1c4f2.firebasestorage.app",
  messagingSenderId: "483778313354",
  appId: "1:483778313354:web:c28c9da35d5674b174c173"
};


    // --------------------------------------------------------

    // Inicializar Firebase (Envoltorio try-catch para detectar errores de config)
    let app, db, auth, provider;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        provider = new GoogleAuthProvider();
        console.log("Firebase OK");
    } catch (e) {
        throw new Error("Error iniciando Firebase. Revisa tus llaves API: " + e.message);
    }

    // VARIABLES
    let currentUser = null;
    let brain = { memory: [], reviewQueue: [], missingLog: [], userDebts: {} };
    let guestCount = parseInt(localStorage.getItem('alexia_guest_count') || "0");
    const MAX_GUEST_CHATS = 5;

    // --- SESI√ìN ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            let role = "user";
            
            // Auto-detectar admin por correo
            if(user.email === "eljacksonyt@gmail.com") role = "admin";
            else if (userSnap.exists()) role = userSnap.data().role || "user";
            
            if (!userSnap.exists()) {
                await setDoc(userRef, { email: user.email, role: role, createdAt: new Date().toISOString() });
            }

            currentUser = { uid: user.uid, name: user.displayName, role: role, email: user.email };
            updateUI(currentUser);
            closeModal();
        } else {
            currentUser = null;
            updateUI(null);
        }
    });

    // --- CEREBRO ---
    onSnapshot(doc(db, "alexia_db", "main_brain"), (snap) => {
        if(snap.exists()) brain = snap.data();
        else setDoc(doc(db, "alexia_db", "main_brain"), brain);
    });

    // --- CHAT LOGIC ---
    window.sendMessage = async function() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;

        // Limite Invitado
        if (!currentUser) {
            if (guestCount >= MAX_GUEST_CHATS) {
                appendMsg('ai', "üîí L√≠mite de prueba alcanzado. Reg√≠strate para continuar (Es gratis).");
                setTimeout(() => openLogin(), 1500);
                input.value = '';
                return;
            }
            guestCount++;
            localStorage.setItem('alexia_guest_count', guestCount);
            updateGuestCounter();
        }

        input.value = '';
        appendMsg('user', text);

        // Buscar en memoria
        const mem = brain.memory.find(m => m.inputs.some(i => text.toLowerCase().includes(i)));
        if (mem) { 
            setTimeout(() => appendMsg('ai', mem.output), 500); 
            return; 
        }

        // Si no sabe
        if (!currentUser) {
            setTimeout(() => appendMsg('ai', "No s√© la respuesta. (Reg√≠strate para ense√±arme)."), 500);
        } else {
            // L√≥gica de aprendizaje (Simplificada para m√≥vil)
            setTimeout(() => appendMsg('ai', "No s√© la respuesta. ¬øT√∫ la sabes?"), 500);
            // Aqu√≠ ir√≠a la l√≥gica de handleTeaching (simplificada para asegurar estabilidad visual primero)
        }
    }

    // --- FUNCIONES UI ---
    window.googleLogin = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
    window.userLogout = () => signOut(auth);
    
    function appendMsg(role, text) {
        const box = document.getElementById('chat-box');
        const row = document.createElement('div');
        row.className = `msg-row ${role}-row`;
        
        let iconHtml = role === 'ai' ? `<div class="msg-icon icon-ai"><i class="fas fa-sparkles"></i></div>` : '';
        row.innerHTML = `${role === 'ai' ? iconHtml : ''}<div class="msg-bubble">${text}</div>`;
        
        if(box.querySelector('h2')) box.innerHTML = ''; 
        box.appendChild(row);
        
        // Scroll autom√°tico al final
        setTimeout(() => box.scrollTop = box.scrollHeight, 100);
    }

    function updateUI(u) {
        const nameSide = document.getElementById('u-name-side');
        const logoutBtn = document.getElementById('logout-opt');
        const counter = document.getElementById('guest-counter');
        
        if(u) {
            nameSide.innerText = u.name;
            logoutBtn.style.display = 'block';
            counter.style.display = 'none';
        } else {
            nameSide.innerText = "Invitado";
            logoutBtn.style.display = 'none';
            updateGuestCounter();
        }
    }

    function updateGuestCounter() {
        const counter = document.getElementById('guest-counter');
        if (!currentUser) {
            const remaining = MAX_GUEST_CHATS - guestCount;
            counter.style.display = 'block';
            counter.innerText = remaining > 0 ? `${remaining} gratuitos` : "L√≠mite alcanzado";
            counter.style.color = remaining > 0 ? '#aaa' : 'var(--danger)';
        }
    }

    // Exponer funciones globales
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    window.openLogin = () => { if(!currentUser) document.getElementById('auth-modal').style.display = 'flex'; }
    window.closeModal = () => document.getElementById('auth-modal').style.display = 'none';
    
    // Evento Enter
    document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    
    // Inicializar contador visual
    updateGuestCounter();

</script>
</body>
</html>


