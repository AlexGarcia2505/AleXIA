<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AleXIA ‚Ä¢ Asistente Inteligente</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0e0e0e;
            color: #eee;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        #header {
            background: #1e1e1e;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        #header-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        #header-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            user-select: none;
        }

        /* CHAT */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #111;
        }

        .message {
            margin-bottom: 14px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.4;
        }

        .user {
            background: #0a4a7a;
            margin-left: auto;
        }

        .bot {
            background: #222;
            border: 1px solid #333;
        }

        /* INPUT */
        #input-area {
            display: flex;
            padding: 10px;
            background: #1c1c1c;
            border-top: 1px solid #333;
        }

        #chat-input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            border-radius: 5px;
            background: #333;
            color: #eee;
        }

        #send-btn {
            margin-left: 10px;
            padding: 10px 15px;
            background: #005d94;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }

        /* FOCO DE SUGERENCIAS */
        #idea-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: yellow;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px #ff0;
        }

        #suggestions-panel {
            position: fixed;
            right: 20px;
            bottom: 160px;
            background: #222;
            border: 1px solid #444;
            padding: 10px;
            width: 200px;
            display: none;
        }

        #suggestions-content .sug-item {
            padding: 8px;
            margin-bottom: 6px;
            background: #333;
            border-radius: 4px;
            cursor: pointer;
        }

        #suggestions-content .sug-item:hover {
            background: #444;
        }
    </style>
</head>

<body>
<div id="app">

    <!-- HEADER -->
    <div id="header">
        <div id="header-title">AleXIA v9</div>
        <div id="header-avatar">A</div>
    </div>

    <!-- CHAT -->
    <div id="chat"></div>

    <!-- INPUT -->
    <div id="input-area">
        <input type="text" id="chat-input" placeholder="Escribe algo..." />
        <button id="send-btn">Enviar</button>
    </div>

    <!-- FOCO -->
    <button id="idea-btn">üí°</button>

    <!-- PANEL -->
    <div id="suggestions-panel">
        <div id="suggestions-content"></div>
    </div>

</div>

<script>
/* -----------------------------
   FUNCIONES B√ÅSICAS DEL CHAT
------------------------------*/
function appendMsg(type, text) {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.className = "message " + type;
    div.innerHTML = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("chat-input").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});
/* -----------------------------
   ENV√çO DE MENSAJES
------------------------------*/
async function sendMessage() {
    const input = document.getElementById("chat-input");
    const text = input.value.trim();
    if (!text) return;

    appendMsg("user", text);
    input.value = "";

    handleUserInput(text);
}

/* -------------------------------------------------------------------
   SISTEMA DE MEMORIA, NOMBRE, DICCIONARIO, BIBLIA, WIKIPEDIA, ETC.
--------------------------------------------------------------------*/

let aleXIA_userName = localStorage.getItem("alexia_user_name") || null;

/* Detectar nombre con frases:
   - "me llamo X"
   - "mi nombre es X"
   - "soy X"
*/
function detectAndSaveName(txt) {
    txt = txt.toLowerCase();

    const patterns = [
        /me llamo\s+([a-z√°√©√≠√≥√∫√± ]+)/i,
        /mi nombre es\s+([a-z√°√©√≠√≥√∫√± ]+)/i,
        /^soy\s+([a-z√°√©√≠√≥√∫√± ]+)/i
    ];

    for (let p of patterns) {
        const m = txt.match(p);
        if (m && m[1]) {
            const name = m[1].trim();
            aleXIA_userName = name;
            localStorage.setItem("alexia_user_name", name);
            return name;
        }
    }
    return null;
}

/* ----------------------------------------------
   Fuzzy Similarity por Trigramas
-----------------------------------------------*/
function trigrams(s) {
    s = s.toLowerCase().replace(/[^a-z0-9√°√©√≠√≥√∫√±√º ]+/g, " ");
    const t = "  " + s + "  ";
    const set = new Set();
    for (let i = 0; i < t.length - 2; i++) {
        set.add(t.slice(i, i + 3));
    }
    return set;
}

function trigramSimilarity(a, b) {
    const A = trigrams(a);
    const B = trigrams(b);
    let inter = 0;

    A.forEach((x) => {
        if (B.has(x)) inter++;
    });

    return inter / (A.size + B.size - inter);
}

/* ----------------------------------------------
   CONSULTA DE BIBLIA: Bible-API
-----------------------------------------------*/
async function fetchBible(query) {
    try {
        const url = `https://bible-api.com/${encodeURIComponent(
            query
        )}?translation=rv1960`;

        const res = await fetch(url);
        if (!res.ok) return null;

        const data = await res.json();
        if (data.text) {
            return `<b>${data.reference}:</b><br>${data.text.replace(
                /\n/g,
                "<br>"
            )}`;
        }
    } catch (e) {}

    return null;
}

/* ----------------------------------------------
   CONSULTA DE DEFINICIONES
-----------------------------------------------*/
async function fetchSpanishDefinition(word) {
    try {
        const r = await fetch(
            `https://api.dictionaryapi.dev/api/v2/entries/es/${word}`
        );

        if (r.ok) {
            const json = await r.json();
            if (json[0]?.meanings) {
                let defs = [];
                json[0].meanings.forEach((m) => {
                    m.definitions?.forEach((d) => defs.push(d.definition));
                });

                if (defs.length > 0) return defs.slice(0, 3).join("<br>");
            }
        }
    } catch (e) {}

    return null;
}

/* ----------------------------------------------
   CONSULTA A WIKIPEDIA
-----------------------------------------------*/
async function fetchWikipedia(term) {
    try {
        const url =
            "https://es.wikipedia.org/api/rest_v1/page/summary/" +
            encodeURIComponent(term);

        const res = await fetch(url);
        if (!res.ok) return null;

        const data = await res.json();
        return data.extract || null;
    } catch (e) {}
    return null;
}

/* -------------------------------------------------------
   MEMORIA DEL SISTEMA ‚Äî Puedes expandir esta estructura
--------------------------------------------------------*/
let memory = [
    {
        inputs: ["qui√©n eres", "qu√© eres", "qu√© es alexia"],
        output:
            "Soy AleXIA, un asistente dise√±ado por Alex Garc√≠a, con memoria, APIs y l√≥gica avanzada."
    },

    {
        inputs: ["qu√© puedes hacer", "para qu√© sirves"],
        output:
            "Puedo responder preguntas usando diccionarios, Wikipedia, Biblia, memoria interna y an√°lisis inteligente."
    }
];

/* Buscar coincidencias difusas dentro de la memoria */
function searchMemory(text) {
    let best = null;
    let bestScore = 0;

    for (const item of memory) {
        for (const inp of item.inputs) {
            const score = trigramSimilarity(inp, text);
            if (score > bestScore) {
                bestScore = score;
                best = item;
            }
        }
    }

    return bestScore > 0.45 ? best : null;
}

/* -------------------------------------------------------
   MANEJO CENTRAL DE ENTRADAS
--------------------------------------------------------*/
async function handleUserInput(txt) {
    const detectedName = detectAndSaveName(txt);

    if (detectedName) {
        appendMsg(
            "bot",
            `Mucho gusto, <b>${detectedName}</b>. Guard√© tu nombre para futuras conversaciones.`
        );
        return;
    }

    if (/\d+:\d+/.test(txt)) {
        let bibleText = await fetchBible(txt);
        if (bibleText) {
            appendMsg("bot", bibleText);
            return;
        }
    }

    let mem = searchMemory(txt);
    if (mem) {
        appendMsg("bot", mem.output);
        return;
    }

    let words = txt.toLowerCase().split(" ");
    if (words.length === 1) {
        let def = await fetchSpanishDefinition(words[0]);
        if (def) {
            appendMsg("bot", `<b>${words[0]}:</b><br>${def}`);
            return;
        }
    }

    let wiki = await fetchWikipedia(txt);
    if (wiki) {
        appendMsg("bot", wiki);
        return;
    }

    appendMsg(
        "bot",
        "No encontr√© respuesta exacta, pero puedo aprender si agregas esta pregunta al panel de memoria."
    );
}
/* -------------------------------------------------------
   FOCO DE SUGERENCIAS
--------------------------------------------------------*/
document.getElementById("idea-btn").onclick = () => {
    const panel = document.getElementById("suggestions-panel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";

    document.getElementById("suggestions-content").innerHTML = `
        <div class="sug-item" onclick="quickAsk('¬øQu√© es la inteligencia artificial?')">
            ¬øQu√© es la IA?
        </div>
        <div class="sug-item" onclick="quickAsk('Explica Juan 3:16')">
            Juan 3:16
        </div>
        <div class="sug-item" onclick="quickAsk('Define felicidad')">
            Definir "felicidad"
        </div>
        <div class="sug-item" onclick="quickAsk('¬øQu√© es la fotos√≠ntesis?')">
            Fotos√≠ntesis
        </div>
    `;
};

function quickAsk(q) {
    appendMsg("user", q);
    handleUserInput(q);
}

/* -------------------------------------------------------
   INICIALIZACI√ìN DEL AVATAR
--------------------------------------------------------*/
if (aleXIA_userName) {
    document.getElementById("header-avatar").innerText =
        aleXIA_userName.charAt(0).toUpperCase();
}

/* CIERRE DEL SCRIPT */
</script>

</body>
</html>
